/**
 * ============================================================
 * УТИЛИТА ДЛЯ ЭКСПОРТА ДАННЫХ В TSV (TAB-SEPARATED VALUES)
 * ============================================================
 * 
 * Версия: 3.1.0 - ИСПРАВЛЕНО (TSV вместо CSV)
 * Дата: 2026-02-04
 * 
 * ИЗМЕНЕНИЯ:
 * ✅ Файл сохраняется как .txt (не .csv)
 * ✅ Разделитель TAB корректно работает
 * ✅ Excel автоматически открывает в колонках
 * ✅ Дробные числа НЕ превращаются в даты
 * 
 * @version 3.1.0
 * ============================================================
 */

/**
 * Форматирование числа для Excel
 * 
 * Дробные числа оборачиваются в формулу ="0.5"
 * чтобы Excel не превращал их в даты
 * 
 * @param {number|string} value - Число для форматирования
 * @returns {string} Отформатированная строка для Excel
 */
const formatNumberForExcel = (value) => {
  const num = parseFloat(value) || 0
  const numStr = num.toString().replace(/,/g, '.')
  
  // Если целое число - возвращаем как есть
  if (Number.isInteger(num)) {
    return numStr
  }
  
  // Если дробное - оборачиваем в формулу
  return `="${numStr}"`
}

/**
 * Экспорт продуктов в TSV файл
 * 
 * TSV = Tab-Separated Values
 * Лучше работает с TAB разделителем чем CSV
 * 
 * @param {Array} products - Массив продуктов для экспорта
 */
export const exportToCSV = (products) => {
  // ============================================================
  // BOM ДЛЯ КОРРЕКТНОГО ОТОБРАЖЕНИЯ КИРИЛЛИЦЫ В EXCEL
  // ============================================================
  const BOM = '\uFEFF'
  
  // ============================================================
  // ЗАГОЛОВКИ ТАБЛИЦЫ (с TAB разделителем)
  // ============================================================
  let tsv = BOM + 'Категория\tНаименование\tТара мл\tБар 1 (Факт)\tБар 2 (Факт)\tХолод. комната (Факт)\r\n'
  
  // ============================================================
  // ГРУППИРОВКА ПО КАТЕГОРИЯМ
  // ============================================================
  const sortedProducts = [...products].sort((a, b) => {
    // Сначала по категории
    const catCompare = (a.category_name || '').localeCompare(b.category_name || '')
    if (catCompare !== 0) return catCompare
    
    // Потом по order_index
    return (a.order_index || 0) - (b.order_index || 0)
  })
  
  // ============================================================
  // ФОРМИРОВАНИЕ СТРОК ДАННЫХ
  // ============================================================
  sortedProducts.forEach(product => {
    // Текстовые поля (без кавычек)
    const category = product.category_name || 'Без категории'
    const name = product.name
    const volume = product.volume || ''
    
    // Числовые поля с правильным форматированием
    const bar1 = formatNumberForExcel(product.bar1 || 0)
    const bar2 = formatNumberForExcel(product.bar2 || 0)
    const cold_room = formatNumberForExcel(product.cold_room || 0)
    
    // Добавляем строку с TAB разделителем
    tsv += `${category}\t${name}\t${volume}\t${bar1}\t${bar2}\t${cold_room}\r\n`
  })
  
  // ============================================================
  // СОЗДАНИЕ И СКАЧИВАНИЕ ФАЙЛА
  // ============================================================
  // ВАЖНО: Сохраняем как .txt чтобы TAB работал правильно
  const blob = new Blob([tsv], { type: 'text/plain;charset=utf-8' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  
  // Имя файла с датой и расширением .txt
  const today = new Date().toISOString().slice(0, 10)
  link.download = `стоки_бара_${today}.txt`
  
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(link.href)
  
  console.log('✅ Экспорт завершен:', `стоки_бара_${today}.txt`)
}

/**
 * ============================================================
 * КАК ОТКРЫТЬ ФАЙЛ В EXCEL
 * ============================================================
 * 
 * СПОСОБ 1 (рекомендуется):
 * 1. Откройте файл двойным кликом
 * 2. Excel автоматически распознает TAB и создаст колонки
 * 
 * СПОСОБ 2 (если не открылся):
 * 1. Откройте Excel
 * 2. Файл → Открыть → Выберите .txt файл
 * 3. Появится мастер импорта:
 *    - Тип данных: "с разделителями"
 *    - Разделитель: поставьте галку "знак табуляции"
 *    - Готово
 * 
 * РЕЗУЛЬТАТ:
 * ┌──────────┬─────────────────┬─────────┬───────┬───────┬─────────┐
 * │Категория │ Наименование    │ Тара мл │ Бар 1 │ Бар 2 │ Холод.  │
 * ├──────────┼─────────────────┼─────────┼───────┼───────┼─────────┤
 * │vermouth  │ Martini Bianco  │ 1000    │ 0     │ 0     │ 0       │
 * │vermouth  │ Martini Rosso   │ 1000    │ 1     │ 0.5   │ 1       │
 * │vodka     │ Бульбашъ        │ 500     │ 2     │ 3     │ 1       │
 * └──────────┴─────────────────┴─────────┴───────┴───────┴─────────┘
 * ============================================================
 */
