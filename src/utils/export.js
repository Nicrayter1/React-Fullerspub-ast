/**
 * ============================================================
 * УТИЛИТА ДЛЯ ЭКСПОРТА ДАННЫХ В CSV
 * ============================================================
 * 
 * Версия: 2.0.0 - ИСПРАВЛЕНО
 * Дата: 2026-02-03
 * 
 * ИСПРАВЛЕНИЯ:
 * ✅ Числа с точкой больше не превращаются в даты в Excel
 * ✅ Правильное форматирование для Excel (числа обернуты как ="0.5")
 * ✅ Данные не плавают по ячейкам
 * ✅ Корректное отображение дробей (0.5, 1.5, 2.75)
 * 
 * @version 2.0.0
 * ============================================================
 */

/**
 * Форматирование числа для Excel CSV
 * 
 * Excel интерпретирует "0.5" как дату "0.май"
 * Решение: обернуть число в формулу ="0.5"
 * Это заставляет Excel воспринимать значение как число
 * 
 * @param {number|string} value - Число для форматирования
 * @returns {string} Отформатированная строка для Excel
 */
const formatNumberForExcel = (value) => {
  // Преобразуем в число
  const num = parseFloat(value) || 0
  
  // Заменяем запятую на точку (если была)
  const numStr = num.toString().replace(/,/g, '.')
  
  // Если число целое (без дробной части) - возвращаем как есть
  if (Number.isInteger(num)) {
    return numStr
  }
  
  // Если дробное - оборачиваем в формулу для Excel
  // ="0.5" заставляет Excel воспринимать это как число
  return `="${numStr}"`
}

/**
 * Экспорт продуктов в CSV файл
 * 
 * ФОРМАТ ФАЙЛА:
 * - Разделитель: ; (точка с запятой)
 * - Кодировка: UTF-8 с BOM (для кириллицы в Excel)
 * - Текстовые поля: обернуты в кавычки
 * - Числа: дробные обернуты как ="0.5"
 * 
 * @param {Array} products - Массив продуктов для экспорта
 */
export const exportToCSV = (products) => {
  // ============================================================
  // BOM ДЛЯ КОРРЕКТНОГО ОТОБРАЖЕНИЯ КИРИЛЛИЦЫ В EXCEL
  // ============================================================
  // Byte Order Mark (BOM) нужен чтобы Excel понял что это UTF-8
  const BOM = '\uFEFF'
  
  // ============================================================
  // ЗАГОЛОВКИ CSV
  // ============================================================
  let csv = BOM + 'Категория;Наименование;Тара мл;Бар 1 (Факт);Бар 2 (Факт);Холод. комната (Факт)\r\n'
  
  // ============================================================
  // ФОРМИРОВАНИЕ СТРОК ДАННЫХ
  // ============================================================
  products.forEach(product => {
    // ============================================================
    // ТЕКСТОВЫЕ ПОЛЯ
    // ============================================================
    // Экранирование кавычек: " → ""
    // Обертка в кавычки для безопасности
    const category = `"${(product.category_name || 'Без категории').replace(/"/g, '""')}"`
    const name = `"${product.name.replace(/"/g, '""')}"`
    const volume = `"${product.volume}"` // Оборачиваем объем в кавычки
    
    // ============================================================
    // ЧИСЛОВЫЕ ПОЛЯ
    // ============================================================
    // Используем новую функцию форматирования
    // Дробные числа будут как ="0.5", целые как "0" или "1"
    const bar1 = formatNumberForExcel(product.bar1 || 0)
    const bar2 = formatNumberForExcel(product.bar2 || 0)
    const cold_room = formatNumberForExcel(product.cold_room || 0)
    
    // ============================================================
    // ДОБАВЛЕНИЕ СТРОКИ В CSV
    // ============================================================
    csv += `${category};${name};${volume};${bar1};${bar2};${cold_room}\r\n`
  })
  
  // ============================================================
  // СОЗДАНИЕ И СКАЧИВАНИЕ ФАЙЛА
  // ============================================================
  // Создаем Blob с правильным MIME типом
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })
  
  // Создаем временную ссылку для скачивания
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  
  // Генерируем имя файла с текущей датой
  const today = new Date().toISOString().slice(0, 10)
  link.download = `стоки_бара_${today}.csv`
  
  // Добавляем в DOM, кликаем, удаляем
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  
  // Освобождаем память
  URL.revokeObjectURL(link.href)
}

