/**
 * ============================================================
 * –£–¢–ò–õ–ò–¢–ê –î–õ–Ø –≠–ö–°–ü–û–†–¢–ê –í CSV (–° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –ü–û–†–Ø–î–ö–ê –ò–ó –ë–î)
 * ============================================================
 * 
 * –í–µ—Ä—Å–∏—è: 5.1.0 - –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö
 * –î–∞—Ç–∞: 2026-02-04
 * 
 * –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
 * ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ö–ê–ö –í –ë–î (order_index)
 * ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –ö–ê–ö –ù–ê –°–ê–ô–¢–ï (–Ω–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
 * ‚úÖ –î—Ä–æ–±–Ω—ã–µ —á–∏—Å–ª–∞ –ù–ï –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –¥–∞—Ç—ã
 * ‚úÖ CSV —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Excel
 * 
 * –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:
 * –®–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ Excel –≤—Ä—É—á–Ω—É—é:
 * - –í—ã–¥–µ–ª–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã D, E, F ‚Üí –§–æ—Ä–º–∞—Ç ‚Üí –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ ‚Üí –ü–æ —Ü–µ–Ω—Ç—Ä—É
 * - –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –º–µ–∂–¥—É –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ ‚Üí –ê–≤—Ç–æ-—à–∏—Ä–∏–Ω–∞
 * 
 * @version 5.1.0
 * ============================================================
 */

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ –¥–ª—è Excel CSV
 * 
 * –î—Ä–æ–±–Ω—ã–µ —á–∏—Å–ª–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º—É–ª—É ="0.5"
 * —á—Ç–æ–±—ã Excel –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª –∏—Ö –≤ –¥–∞—Ç—ã
 * 
 * @param {number|string} value - –ß–∏—Å–ª–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è Excel
 */
const formatNumberForExcel = (value) => {
  const num = parseFloat(value) || 0
  const numStr = num.toString().replace(/,/g, '.')
  
  // –ï—Å–ª–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (Number.isInteger(num)) {
    return numStr
  }
  
  // –ï—Å–ª–∏ –¥—Ä–æ–±–Ω–æ–µ - –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Ñ–æ—Ä–º—É–ª—É
  return `="${numStr}"`
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ CSV —Ñ–∞–π–ª
 * 
 * –ü–û–†–Ø–î–û–ö:
 * - –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (is_frozen = true)
 * - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ order_index (–∫–∞–∫ –≤ –ë–î)
 * - –ù–ï –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
 * - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ —á—Ç–æ –∏ –Ω–∞ —Å–∞–π—Ç–µ
 * 
 * @param {Array} products - –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
 */
export const exportToCSV = (products) => {
  // ============================================================
  // BOM –î–õ–Ø –ö–û–†–†–ï–ö–¢–ù–û–ì–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ò–†–ò–õ–õ–ò–¶–´ –í EXCEL
  // ============================================================
  const BOM = '\uFEFF'
  
  // ============================================================
  // –ó–ê–ì–û–õ–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´
  // ============================================================
  let csv = BOM + '–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–¢–∞—Ä–∞ –º–ª;–ë–∞—Ä 1 (–§–∞–∫—Ç);–ë–∞—Ä 2 (–§–∞–∫—Ç);–•–æ–ª–æ–¥. –∫–æ–º–Ω–∞—Ç–∞ (–§–∞–∫—Ç)\r\n'
  
  // ============================================================
  // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ó–ê–ú–û–†–û–ñ–ï–ù–ù–´–• –ü–†–û–î–£–ö–¢–û–í
  // ============================================================
  // –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —Å is_frozen = true
  const activeProducts = products.filter(product => !product.is_frozen)
  
  console.log('‚ùÑÔ∏è –í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', products.length)
  console.log('‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö (–Ω–µ–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö):', activeProducts.length)
  console.log('üö´ –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö (–ø—Ä–æ–ø—É—â–µ–Ω–æ):', products.length - activeProducts.length)
  
  // ============================================================
  // –°–û–†–¢–ò–†–û–í–ö–ê –ü–û ORDER_INDEX (–ö–ê–ö –í –ë–î –ò –ù–ê –°–ê–ô–¢–ï)
  // ============================================================
  // –í–ê–ñ–ù–û: –°–æ—Ä—Ç–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –ø–æ order_index
  // –ù–ï –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –±—É–¥–µ—Ç –¢–û–ß–ù–û –∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ
  const sortedProducts = [...activeProducts].sort((a, b) => {
    const orderA = Number(a.order_index) || 0
    const orderB = Number(b.order_index) || 0
    return orderA - orderB
  })
  
  console.log('üìä –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ë–î:', sortedProducts.length)
  
  // ============================================================
  // –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–¢–†–û–ö –î–ê–ù–ù–´–•
  // ============================================================
  sortedProducts.forEach((product, index) => {
    // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—Ä—è–¥–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (index < 5) {
      console.log(`${index + 1}. ${product.name} (order_index: ${product.order_index})`)
    }
    
    // –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã)
    const category = product.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
    const name = product.name
    const volume = product.volume || ''
    
    // –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    const bar1 = formatNumberForExcel(product.bar1 || 0)
    const bar2 = formatNumberForExcel(product.bar2 || 0)
    const cold_room = formatNumberForExcel(product.cold_room || 0)
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    csv += `${category};${name};${volume};${bar1};${bar2};${cold_room}\r\n`
  })
  
  // ============================================================
  // –°–û–ó–î–ê–ù–ò–ï –ò –°–ö–ê–ß–ò–í–ê–ù–ò–ï –§–ê–ô–õ–ê
  // ============================================================
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  
  // –ò–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
  const today = new Date().toISOString().slice(0, 10)
  link.download = `—Å—Ç–æ–∫–∏_–±–∞—Ä–∞_${today}.csv`
  
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(link.href)
  
  console.log('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω:', `—Å—Ç–æ–∫–∏_–±–∞—Ä–∞_${today}.csv`)
  console.log('üìä –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', sortedProducts.length)
}

/**
 * ============================================================
 * –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Æ –í EXCEL
 * ============================================================
 * 
 * –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ –≤ Excel:
 * 
 * 1. –ù–ê–°–¢–†–û–ô–ö–ê –®–ò–†–ò–ù–´ –°–¢–û–õ–ë–¶–û–í:
 *    - –í—ã–¥–µ–ª–∏—Ç–µ –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã (–∫–ª–∏–∫ –Ω–∞ A, Shift+–∫–ª–∏–∫ –Ω–∞ F)
 *    - –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –º–µ–∂–¥—É –ª—é–±—ã–º–∏ –¥–≤—É–º—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
 *    - Excel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
 * 
 * 2. –í–´–†–ê–í–ù–ò–í–ê–ù–ò–ï –ß–ò–°–ï–õ –ü–û –¶–ï–ù–¢–†–£:
 *    - –í—ã–¥–µ–ª–∏—Ç–µ —Å—Ç–æ–ª–±—Ü—ã D, E, F (–ë–∞—Ä 1, –ë–∞—Ä 2, –•–æ–ª–æ–¥.)
 *    - –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí –§–æ—Ä–º–∞—Ç —è—á–µ–µ–∫
 *    - –í–∫–ª–∞–¥–∫–∞ "–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ"
 *    - –ü–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏: "–ü–æ —Ü–µ–Ω—Ç—Ä—É"
 *    - –û–ö
 * 
 * 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –ö–ê–ö –®–ê–ë–õ–û–ù (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
 *    - –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 *    - –§–∞–π–ª ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ ‚Üí –®–∞–±–ª–æ–Ω Excel (.xltx)
 *    - –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω
 * 
 * ============================================================
 * 
 * –ü–û–†–Ø–î–û–ö –ü–†–û–î–£–ö–¢–û–í:
 * 
 * –ü—Ä–æ–¥—É–∫—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö order_index –∏–∑ –ë–î.
 * –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ:
 * - –ü–æ—Ä—è–¥–æ–∫ –≤ Excel = –ü–æ—Ä—è–¥–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ
 * - –ù–µ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
 * - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
 * 
 * –ü—Ä–∏–º–µ—Ä:
 * 1. Martini Bianco (order_index: 1)
 * 2. Martini Rosso (order_index: 2)
 * 3. Martini Fiero (order_index: 3)
 * 4. –ë—É–ª—å–±–∞—à—ä (order_index: 4)
 * ...
 * 
 * ============================================================
 */
