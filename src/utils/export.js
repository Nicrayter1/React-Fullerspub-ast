/**
 * ============================================================
 * УТИЛИТА ДЛЯ ЭКСПОРТА ДАННЫХ В CSV (ВЕРТИКАЛЬНЫЙ ФОРМАТ)
 * ============================================================
 * 
 * Версия: 3.0.0 - ПРАВИЛЬНЫЙ ФОРМАТ ДЛЯ EXCEL
 * Дата: 2026-02-04
 * 
 * СТРУКТУРА:
 * - Вертикальная таблица (как на скриншоте)
 * - Категория и продукты вертикально
 * - Числа с точкой НЕ превращаются в даты
 * 
 * @version 3.0.0
 * ============================================================
 */

/**
 * Форматирование числа для Excel CSV
 * 
 * Дробные числа оборачиваются в формулу ="0.5"
 * чтобы Excel не превращал их в даты
 * 
 * @param {number|string} value - Число для форматирования
 * @returns {string} Отформатированная строка для Excel
 */
const formatNumberForExcel = (value) => {
  const num = parseFloat(value) || 0
  const numStr = num.toString().replace(/,/g, '.')
  
  // Если целое число - возвращаем как есть
  if (Number.isInteger(num)) {
    return numStr
  }
  
  // Если дробное - оборачиваем в формулу
  return `="${numStr}"`
}

/**
 * Экспорт продуктов в CSV файл (ВЕРТИКАЛЬНЫЙ ФОРМАТ)
 * 
 * ФОРМАТ (как на скриншоте):
 * 
 * | Категория | Наименование | Тара мл | Бар 1 | Бар 2 | Холод. |
 * |-----------|--------------|---------|-------|-------|--------|
 * | vermouth  | Martini Bianco| 1000   | 0     | 0     | 0      |
 * | vermouth  | Martini Rosso | 1000   | 1     | 0.5   | 1      |
 * 
 * @param {Array} products - Массив продуктов для экспорта
 */
export const exportToCSV = (products) => {
  // ============================================================
  // BOM ДЛЯ КОРРЕКТНОГО ОТОБРАЖЕНИЯ КИРИЛЛИЦЫ В EXCEL
  // ============================================================
  const BOM = '\uFEFF'
  
  // ============================================================
  // ЗАГОЛОВКИ ТАБЛИЦЫ
  // ============================================================
  // Точно как на скриншоте
  let csv = BOM + 'Категория\tНаименование\tТара мл\tБар 1 (Факт)\tБар 2 (Факт)\tХолод. комната (Факт)\r\n'
  
  // ============================================================
  // ГРУППИРОВКА ПО КАТЕГОРИЯМ
  // ============================================================
  // Сортируем продукты по категориям для красивого отображения
  const sortedProducts = [...products].sort((a, b) => {
    // Сначала по категории
    const catCompare = (a.category_name || '').localeCompare(b.category_name || '')
    if (catCompare !== 0) return catCompare
    
    // Потом по order_index
    return (a.order_index || 0) - (b.order_index || 0)
  })
  
  // ============================================================
  // ФОРМИРОВАНИЕ СТРОК ДАННЫХ
  // ============================================================
  sortedProducts.forEach(product => {
    // Категория (без кавычек, простой текст)
    const category = product.category_name || 'Без категории'
    
    // Наименование (без кавычек)
    const name = product.name
    
    // Тара мл (число без кавычек)
    const volume = product.volume || ''
    
    // Остатки с правильным форматированием
    const bar1 = formatNumberForExcel(product.bar1 || 0)
    const bar2 = formatNumberForExcel(product.bar2 || 0)
    const cold_room = formatNumberForExcel(product.cold_room || 0)
    
    // Добавляем строку (разделитель TAB как в Excel)
    csv += `${category}\t${name}\t${volume}\t${bar1}\t${bar2}\t${cold_room}\r\n`
  })
  
  // ============================================================
  // СОЗДАНИЕ И СКАЧИВАНИЕ ФАЙЛА
  // ============================================================
  const blob = new Blob([csv], { type: 'text/tab-separated-values;charset=utf-8' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  
  // Имя файла с датой
  const today = new Date().toISOString().slice(0, 10)
  link.download = `стоки_бара_${today}.csv`
  
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(link.href)
}

/**
 * ============================================================
 * ПРИМЕР РЕЗУЛЬТАТА
 * ============================================================
 * 
 * Категория    Наименование           Тара мл  Бар 1  Бар 2    Холод.
 * vermouth     Martini Bianco         1000     0      0        0
 * vermouth     Martini Rosso          1000     1      ="0.5"   1
 * vermouth     Martini Fiero          750      0      1        0
 * vodka        Бульбашъ               500      2      3        1
 * vodka        Smirnoff Red           500      2      ="3.5"   1
 * vodka        Grey Goose             1000     1      3        2
 * cognac       Courvoisier VS         700      1      ="0.5"   0
 * 
 * В Excel:
 * - 0.5 отображается как 0.5 (НЕ как 0.май)
 * - Таблица вертикальная (строка = продукт)
 * - Категории повторяются для каждого продукта
 * ============================================================
 */
