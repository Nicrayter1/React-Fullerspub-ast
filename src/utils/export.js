/**
 * ============================================================
 * УТИЛИТА ДЛЯ ЭКСПОРТА ДАННЫХ В CSV (ФИНАЛЬНАЯ ВЕРСИЯ)
 * ============================================================
 * 
 * Версия: 4.0.0 - ОКОНЧАТЕЛЬНОЕ ИСПРАВЛЕНИЕ
 * Дата: 2026-02-04
 * 
 * ИСПРАВЛЕНИЯ:
 * ✅ Точка с запятой как разделитель (НЕ TAB)
 * ✅ Без кавычек вокруг текста
 * ✅ Дробные числа НЕ превращаются в даты
 * ✅ Данные автоматически в колонках
 * 
 * @version 4.0.0
 * ============================================================
 */

/**
 * Форматирование числа для Excel CSV
 * 
 * Дробные числа оборачиваются в формулу ="0.5"
 * чтобы Excel не превращал их в даты
 * 
 * @param {number|string} value - Число для форматирования
 * @returns {string} Отформатированная строка для Excel
 */
const formatNumberForExcel = (value) => {
  const num = parseFloat(value) || 0
  const numStr = num.toString().replace(/,/g, '.')
  
  // Если целое число - возвращаем как есть
  if (Number.isInteger(num)) {
    return numStr
  }
  
  // Если дробное - оборачиваем в формулу
  return `="${numStr}"`
}

/**
 * Экспорт продуктов в CSV файл
 * 
 * ФОРМАТ:
 * - Разделитель: ; (точка с запятой)
 * - БЕЗ кавычек вокруг текста
 * - Дробные числа: ="0.5"
 * - Вертикальная структура
 * 
 * @param {Array} products - Массив продуктов для экспорта
 */
export const exportToCSV = (products) => {
  // ============================================================
  // BOM ДЛЯ КОРРЕКТНОГО ОТОБРАЖЕНИЯ КИРИЛЛИЦЫ В EXCEL
  // ============================================================
  const BOM = '\uFEFF'
  
  // ============================================================
  // ЗАГОЛОВКИ ТАБЛИЦЫ
  // ============================================================
  // БЕЗ кавычек, разделитель ;
  let csv = BOM + 'Категория;Наименование;Тара мл;Бар 1 (Факт);Бар 2 (Факт);Холод. комната (Факт)\r\n'
  
  // ============================================================
  // ГРУППИРОВКА ПО КАТЕГОРИЯМ
  // ============================================================
  const sortedProducts = [...products].sort((a, b) => {
    // Сначала по категории
    const catCompare = (a.category_name || '').localeCompare(b.category_name || '')
    if (catCompare !== 0) return catCompare
    
    // Потом по order_index
    return (a.order_index || 0) - (b.order_index || 0)
  })
  
  // ============================================================
  // ФОРМИРОВАНИЕ СТРОК ДАННЫХ
  // ============================================================
  sortedProducts.forEach(product => {
    // ============================================================
    // ТЕКСТОВЫЕ ПОЛЯ БЕЗ КАВЫЧЕК
    // ============================================================
    const category = product.category_name || 'Без категории'
    const name = product.name
    const volume = product.volume || ''
    
    // ============================================================
    // ЧИСЛОВЫЕ ПОЛЯ
    // ============================================================
    const bar1 = formatNumberForExcel(product.bar1 || 0)
    const bar2 = formatNumberForExcel(product.bar2 || 0)
    const cold_room = formatNumberForExcel(product.cold_room || 0)
    
    // ============================================================
    // ДОБАВЛЕНИЕ СТРОКИ
    // ============================================================
    // Разделитель ; (точка с запятой)
    // БЕЗ кавычек!
    csv += `${category};${name};${volume};${bar1};${bar2};${cold_room}\r\n`
  })
  
  // ============================================================
  // СОЗДАНИЕ И СКАЧИВАНИЕ ФАЙЛА
  // ============================================================
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  
  const today = new Date().toISOString().slice(0, 10)
  link.download = `стоки_бара_${today}.csv`
  
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(link.href)
}

/**
 * ============================================================
 * ПРИМЕР РЕЗУЛЬТАТА
 * ============================================================
 * 
 * Файл CSV:
 * Категория;Наименование;Тара мл;Бар 1 (Факт);Бар 2 (Факт);Холод. комната (Факт)
 * vermouth;Martini Bianco;1000;0;0;0
 * vermouth;Martini Rosso;1000;1;="0.5";1
 * vermouth;Martini Fiero;750;0;1;0
 * vodka;Бульбашъ;500;2;3;1
 * vodka;Smirnoff Red;500;2;="3.5";1
 * 
 * В Excel:
 * ┌──────────┬────────────────┬─────────┬───────┬───────┬─────────┐
 * │Категория │ Наименование   │ Тара мл │ Бар 1 │ Бар 2 │ Холод.  │
 * ├──────────┼────────────────┼─────────┼───────┼───────┼─────────┤
 * │vermouth  │ Martini Bianco │ 1000    │ 0     │ 0     │ 0       │
 * │vermouth  │ Martini Rosso  │ 1000    │ 1     │ 0.5   │ 1       │
 * │vermouth  │ Martini Fiero  │ 750     │ 0     │ 1     │ 0       │
 * │vodka     │ Бульбашъ       │ 500     │ 2     │ 3     │ 1       │
 * │vodka     │ Smirnoff Red   │ 500     │ 2     │ 3.5   │ 1       │
 * └──────────┴────────────────┴─────────┴───────┴───────┴─────────┘
 * 
 * КЛЮЧЕВЫЕ МОМЕНТЫ:
 * ✅ Разделитель ; (точка с запятой)
 * ✅ БЕЗ кавычек
 * ✅ Дробные числа как ="0.5"
 * ✅ Данные автоматически в колонках
 * ============================================================
 */
