/**
 * ============================================================
 * API —Å–ª–æ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase
 * ============================================================
 * 
 * –í–µ—Ä—Å–∏—è: 2.2.0 - –ò–°–ü–†–ê–í–õ–ï–ù–û
 * –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 2026-02-01
 * 
 * –ò–ó–ú–ï–ù–ï–ù–ò–Ø v2.2:
 * ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã insertProduct() –∏ insertCategory()
 * ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å ID overflow (Date.now() —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π)
 * ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ syncAll()
 * ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * ‚úÖ –í–æ–∑–≤—Ä–∞—Ç userMessage –¥–ª—è UI
 * ‚úÖ –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —É—Å–ø–µ—Ö–µ
 * 
 * @version 2.2.0
 * @author Migration Team
 * @date 2026-02-01
 * ============================================================
 */

import { createClient } from '@supabase/supabase-js'
import { bulkUpdateProducts } from './bulkOperations'
import { delay } from '../utils/helpers'

// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE
// ============================================================

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è')
  console.error('   VITE_SUPABASE_URL –∏ VITE_SUPABASE_ANON_KEY')
}

/**
 * ============================================================
 * –ö–õ–ò–ï–ù–¢ SUPABASE
 * ============================================================
 * 
 * –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Supabase
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
 * - persistSession: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ localStorage
 * - autoRefreshToken: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω
 * - detectSessionInUrl: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ URL (–¥–ª—è OAuth)
 */
export const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
})

/**
 * ============================================================
 * –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
 * ============================================================
 */

/**
 * ============================================================
 * –ö–õ–ê–°–° API
 * ============================================================
 * 
 * –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase API
 * –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
 */
class SupabaseAPI {
  constructor() {
    this.client = supabaseClient
  }

  /**
   * ============================================================
   * –ü–û–õ–£–ß–ò–¢–¨ –°–õ–ï–î–£–Æ–©–ò–ô order_index
   * ============================================================
   *
   * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç MAX(order_index) –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç MAX + 1.
   * –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±: –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ,
   * —Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–µ–π—á–∞—Å –≤ –º–∞—Å—Å–∏–≤–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.
   *
   * –ü—Ä–æ–±–ª–µ–º–∞ length+1:
   *   –ë—ã–ª–æ 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π (1,2,3,4,5) ‚Üí —É–¥–∞–ª–∏–ª–∏ 4 –∏ 5 ‚Üí length = 3
   *   –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: order_index = 3+1 = 4
   *   –ï—â—ë –æ–¥–Ω–∞:        order_index = 3+1 = 4  ‚Üê –¥—É–±–ª–∏–∫–∞—Ç! –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–º–∞–Ω–∞.
   *
   * –†–µ—à–µ–Ω–∏–µ MAX+1:
   *   MAX –≤ –±–∞–∑–µ = 3 ‚Üí —Å–ª–µ–¥—É—é—â–∏–π = 4 ‚úÖ
   *   –°–Ω–æ–≤–∞ MAX  = 4 ‚Üí —Å–ª–µ–¥—É—é—â–∏–π = 5 ‚úÖ
   *
   * @param {'products'|'categories'} table - –¢–∞–±–ª–∏—Ü–∞
   * @param {number|null} categoryId - –¢–æ–ª—å–∫–æ –¥–ª—è products: —Å—á–∏—Ç–∞–µ—Ç –∏–Ω–¥–µ–∫—Å
   *                                   –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∞ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
   * @returns {Promise<number>} –°–ª–µ–¥—É—é—â–∏–π order_index
   */
  async getNextOrderIndex(table, categoryId = null) {
    let query = this.client
      .from(table)
      .select('order_index')
      .order('order_index', { ascending: false })
      .limit(1)

    if (table === 'products' && categoryId !== null) {
      query = query.eq('category_id', categoryId)
    }

    const { data, error } = await query

    if (error) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è max order_index (${table}):`, error)
      return 9999
    }

    const maxIndex = data?.[0]?.order_index ?? 0
    return maxIndex + 1
  }

  /**
   * ============================================================
   * –ó–ê–ì–†–£–ó–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ô
   * ============================================================
   * 
   * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ order_index –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   * 
   * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
   * @throws {Error} –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
   */
  async fetchCategories() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...')
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ categories
    const { data, error } = await this.client
      .from('categories')
      .select('*')
      .order('order_index')

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error)
      throw error
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`)
    return data
  }

  /**
   * ============================================================
   * –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–î–£–ö–¢–û–í
   * ============================================================
   * 
   * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ order_index (null –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ)
   * 
   * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @throws {Error} –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
   */
  async fetchProducts() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...')
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ products
    // nullsLast: true - –ø—Ä–æ–¥—É–∫—Ç—ã –±–µ–∑ order_index –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞
    const { data, error } = await this.client
      .from('products')
      .select('*')
      .order('order_index', { nullsLast: true })

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error)
      throw error
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`)
    return data
  }

  /**
   * ============================================================
   * –í–°–¢–ê–í–ö–ê –ù–û–í–û–ì–û –ü–†–û–î–£–ö–¢–ê
   * ============================================================
   * 
   * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   * PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ID —á–µ—Ä–µ–∑ SERIAL
   * –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å Date.now() (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ID)
   * 
   * @param {Object} productData - –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {number} productData.category_id - ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param {string} productData.name - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string} productData.volume - –û–±—ä–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "750ml")
   * @param {number} productData.bar1 - –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –±–∞—Ä–µ 1
   * @param {number} productData.bar2 - –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –±–∞—Ä–µ 2
   * @param {number} productData.cold_room - –û—Å—Ç–∞—Ç–æ–∫ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
   * @param {number} [productData.order_index] - –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * 
   * @returns {Promise<Object>} –°–æ–∑–¥–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ID
   * @throws {Error} –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
   */
  async insertProduct(productData) {
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞:', productData.name)

    try {
      // –°—á–∏—Ç–∞–µ–º order_index –ø—Ä—è–º–æ –∏–∑ –±–∞–∑—ã: MAX –ø–æ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + 1
      // –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏—è—Ö (—Å–º. getNextOrderIndex)
      const orderIndex = await this.getNextOrderIndex('products', productData.category_id)

      const { data, error } = await this.client
        .from('products')
        .insert([{
          category_id: productData.category_id,
          name: productData.name,
          volume: productData.volume,
          bar1: productData.bar1 ?? 0,
          bar2: productData.bar2 ?? 0,
          cold_room: productData.cold_room ?? 0,
          order_index: orderIndex,
          is_frozen: false,
          visible_to_bar1: true,
          visible_to_bar2: true
        }])
        .select()
        .single()

      if (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:', error)
        throw error
      }

      console.log('‚úÖ –ü—Ä–æ–¥—É–∫—Ç —Å–æ–∑–¥–∞–Ω —Å ID:', data.id, '| order_index:', orderIndex)
      return data

    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', error)
      throw error
    }
  }

  /**
   * ============================================================
   * –í–°–¢–ê–í–ö–ê –ù–û–í–û–ô –ö–ê–¢–ï–ì–û–†–ò–ò
   * ============================================================
   * 
   * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   * PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ID —á–µ—Ä–µ–∑ SERIAL
   * –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å Date.now() (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ID)
   * 
   * @param {Object} categoryData - –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param {string} categoryData.name - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param {number} categoryData.order_index - –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
   * 
   * @returns {Promise<Object>} –°–æ–∑–¥–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ID
   * @throws {Error} –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
   */
  async insertCategory(categoryData) {
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', categoryData.name)

    try {
      // –°—á–∏—Ç–∞–µ–º order_index –ø—Ä—è–º–æ –∏–∑ –±–∞–∑—ã: MAX –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º + 1
      // –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏—è—Ö (—Å–º. getNextOrderIndex)
      const orderIndex = await this.getNextOrderIndex('categories')

      const { data, error } = await this.client
        .from('categories')
        .insert([{
          name: categoryData.name,
          order_index: orderIndex
        }])
        .select()
        .single()

      if (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error)
        throw error
      }

      console.log('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å ID:', data.id, '| order_index:', orderIndex)
      return data

    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error)
      throw error
    }
  }

  /**
   * ============================================================
   * –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–î–ù–û–ì–û –ü–†–û–î–£–ö–¢–ê
   * ============================================================
   * 
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–µ—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   * –î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ syncAll()
   * 
   * –í–∫–ª—é—á–∞–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫:
   * - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –¥–æ 2 —Ä–∞–∑
   * - –° —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è –∑–∞–¥–µ—Ä–∂–∫–æ–π (1 —Å–µ–∫, 2 —Å–µ–∫)
   * 
   * @param {number} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   * @param {Object} updates - –û–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   * @param {number} [updates.bar1] - –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ –±–∞—Ä 1
   * @param {number} [updates.bar2] - –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ –±–∞—Ä 2
   * @param {number} [updates.cold_room] - –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ —Ö–æ–ª–æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
   * @param {number} [retryCount=0] - –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ)
   * 
   * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ {success, productId, error?}
   */
  async updateProductStock(productId, updates, retryCount = 0) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    try {
      // –í—ã–ø–æ–ª–Ω—è–µ–º UPDATE –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      const { error } = await this.client
        .from('products')
        .update(updates)
        .eq('id', productId)

      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
      if (error) throw error
      
      // –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      return { success: true, productId }
      
    } catch (error) {
      // Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –∏ —ç—Ç–æ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞?
      if (retryCount < 2 && (
        error.message.includes('fetch') || 
        error.message.includes('network')
      )) {
        console.warn(`‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}, –ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}`)
        
        // –ó–∞–¥–µ—Ä–∂–∫–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º: 1 —Å–µ–∫, 2 —Å–µ–∫
        await delay(1000 * (retryCount + 1))
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Å—á–µ—Ç—á–∏–∫–æ–º
        return this.updateProductStock(productId, updates, retryCount + 1)
      }
      
      // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã –∏–ª–∏ –Ω–µ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}:`, error)
      return { 
        success: false, 
        productId, 
        error: error.message 
      }
    }
  }

  /**
   * ============================================================
   * –ú–ê–°–°–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í (Bulk RPC)
   * ============================================================
   * 
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞ –û–î–ò–ù –∑–∞–ø—Ä–æ—Å
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL —Ñ—É–Ω–∫—Ü–∏—é bulk_update_products —á–µ—Ä–µ–∑ RPC
   * 
   * –í–ï–†–°–ò–Ø v2.1 - –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
   * - –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —É—Å–ø–µ—Ö–µ
   * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç userMessage –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   * - –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CORS –∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
   * - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   * 
   * –ü–†–û–¶–ï–°–°:
   * 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   * 2. –í—ã–∑–æ–≤ bulkUpdateProducts() –∏–∑ –º–æ–¥—É–ª—è bulkOperations
   * 3. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—É—Å–ø–µ—Ö/—á–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö/–ø—Ä–æ–≤–∞–ª)
   * 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–æ–∫
   * 5. –í–æ–∑–≤—Ä–∞—Ç –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è UI
   * 
   * @param {Array} products - –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   *                           –ö–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   *                           - id: number
   *                           - bar1: number
   *                           - bar2: number
   *                           - cold_room: number
   * 
   * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
   * {
   *   success: boolean,        // true —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ
   *   total: number,           // –í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   *   updated: number,         // –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
   *   failed: number,          // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
   *   errors: Array,           // –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ [{product_id, error}]
   *   duration: number,        // –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–º—Å)
   *   userMessage: string,     // –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   *   hasCORSErrors: boolean   // –ë—ã–ª–∏ –ª–∏ CORS –æ—à–∏–±–∫–∏
   * }
   */
  async syncAll(products, availableColumns) {
    // ============================================================
    // –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•
    // ============================================================
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –µ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    if (!products || products.length === 0) {
      console.log('‚ö†Ô∏è syncAll: –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏')
      return { 
        success: true, 
        total: 0, 
        updated: 0, 
        failed: 0,
        errors: [],
        duration: 0,
        userMessage: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è',
        hasCORSErrors: false
      }
    }

    console.log(`üîÑ –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ Bulk RPC...`)
    
    // ============================================================
    // –í–´–ó–û–í BULK RPC –§–£–ù–ö–¶–ò–ò
    // ============================================================
    
    try {
      // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –º–æ–¥—É–ª—è bulkOperations
      // –û–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL —Ñ—É–Ω–∫—Ü–∏—é bulk_update_products
      const result = await bulkUpdateProducts(products, availableColumns)
      
      // ============================================================
      // –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê
      // ============================================================
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', {
        success: result.success,
        updated: result.updated,
        failed: result.failed,
        total: result.total,
        duration: result.duration
      })
      
      // –í–ê–ñ–ù–û: –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
      // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è UI
      // UI —Å–∞–º —Ä–µ—à–∏—Ç –∫–∞–∫ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
      if (result.success) {
        // –ü–æ–ª–Ω—ã–π —É—Å–ø–µ—Ö - –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
        console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
      } else if (result.updated > 0) {
        // –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö - —á–∞—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
        console.warn(`‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${result.updated}/${result.total}`)
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª–∏ –ª–∏ CORS –æ—à–∏–±–∫–∏
        if (result.hasCORSErrors) {
          console.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã CORS –æ—à–∏–±–∫–∏ - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é')
        }
      } else {
        // –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª - –Ω–∏ –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω
        console.error('‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å')
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–≤–∞–ª–∞
        if (result.hasCORSErrors) {
          console.error('‚ùå –ü—Ä–∏—á–∏–Ω–∞: CORS/—Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏')
        }
      }
      
      // ============================================================
      // –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–ï–¢–ê–õ–ï–ô –û–®–ò–ë–û–ö
      // ============================================================
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –≤ –∫–æ–Ω—Å–æ–ª–∏
      if (result.errors.length > 0) {
        console.group('üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫:')
        result.errors.forEach((error, index) => {
          console.error(`${index + 1}.`, error)
        })
        console.groupEnd()
      }
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ UI
      return result
      
    } catch (error) {
      // ============================================================
      // –û–ë–†–ê–ë–û–¢–ö–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö
      // ============================================================
      
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error)
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
      // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ UI –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      return {
        success: false,
        total: products.length,
        updated: 0,
        failed: products.length,
        errors: [{
          error: error.message || 'Unknown error',
          type: 'critical'
        }],
        duration: 0,
        userMessage: `‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É'}`,
        hasCORSErrors: error.message?.toLowerCase().includes('cors') || 
                       error.message?.toLowerCase().includes('network')
      }
    }
  }

}

/**
 * ============================================================
 * –≠–ö–°–ü–û–†–¢
 * ============================================================
 * 
 * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä API (Singleton pattern)
 * –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç
 */
export default new SupabaseAPI()