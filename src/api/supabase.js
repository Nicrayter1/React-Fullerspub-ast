/**
 * ============================================================
 * API —Å–ª–æ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase
 * ============================================================
 * 
 * –í–µ—Ä—Å–∏—è: 2.0.0 (Migrated to Bulk RPC)
 * –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 2026-01-31
 * 
 * –ò–∑–æ–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
 * 
 * –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í v2.0:
 * ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è syncAll() –Ω–∞ Bulk RPC
 * ‚úÖ –£–¥–∞–ª–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥ batch updates
 * ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
 * ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
 * ============================================================
 */

import { createClient } from '@supabase/supabase-js'
import { bulkUpdateProducts } from './bulkOperations'

// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE
// ============================================================

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è')
  console.error('   VITE_SUPABASE_URL –∏ VITE_SUPABASE_ANON_KEY')
}

/**
 * ============================================================
 * –ö–õ–ò–ï–ù–¢ SUPABASE
 * ============================================================
 */
export const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,      // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ localStorage
    autoRefreshToken: true,    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω
    detectSessionInUrl: true   // –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ URL (–¥–ª—è OAuth)
  }
})

/**
 * ============================================================
 * –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
 * ============================================================
 */

/**
 * –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è retry –ª–æ–≥–∏–∫–∏)
 * @param {number} ms - –ú–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
 */
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms))

/**
 * ============================================================
 * –ö–õ–ê–°–° API
 * ============================================================
 */
class SupabaseAPI {
  constructor() {
    this.client = supabaseClient
  }

  /**
   * ============================================================
   * –ó–ê–ì–†–£–ó–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ô
   * ============================================================
   * 
   * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –ë–î, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ order_index
   * 
   * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
   * @throws {Error} –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏
   */
  async fetchCategories() {
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...')
    
    const { data, error } = await this.client
      .from('categories')
      .select('*')
      .order('order_index')

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error)
      throw error
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`)
    return data
  }

  /**
   * ============================================================
   * –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–î–£–ö–¢–û–í
   * ============================================================
   * 
   * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –ë–î, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ order_index
   * Null –∑–Ω–∞—á–µ–Ω–∏—è order_index –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü
   * 
   * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @throws {Error} –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏
   */
  async fetchProducts() {
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...')
    
    const { data, error } = await this.client
      .from('products')
      .select('*')
      .order('order_index', { nullsLast: true })

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error)
      throw error
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ order_index)`)
    return data
  }

  /**
   * ============================================================
   * –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–î–ù–û–ì–û –ü–†–û–î–£–ö–¢–ê
   * ============================================================
   * 
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–µ—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   * 
   * @param {number} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {Object} updates - –û–±—ä–µ–∫—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ {bar1, bar2, cold_room}
   * @param {number} retryCount - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–¥–ª—è retry –ª–æ–≥–∏–∫–∏)
   * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ {success, productId, error?}
   */
  async updateProductStock(productId, updates, retryCount = 0) {
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }

    try {
      const { error } = await this.client
        .from('products')
        .update(updates)
        .eq('id', productId)

      if (error) throw error
      
      return { success: true, productId }
      
    } catch (error) {
      // Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
      if (retryCount < 2 && (
        error.message.includes('fetch') || 
        error.message.includes('network')
      )) {
        console.warn(
          `‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}, –ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}`
        )
        await delay(1000 * (retryCount + 1)) // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        return this.updateProductStock(productId, updates, retryCount + 1)
      }
      
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}:`, error)
      return { 
        success: false, 
        productId, 
        error: error.message 
      }
    }
  }

  /**
   * ============================================================
   * –ú–ê–°–°–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í (Bulk RPC)
   * ============================================================
   * 
   * ‚úÖ –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø v2.0 - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Bulk RPC
   * 
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ë–î –∑–∞ –û–î–ò–ù –∑–∞–ø—Ä–æ—Å
   * –ù–∞–º–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
   * 
   * –ü—Ä–æ—Ü–µ—Å—Å:
   * 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   * 2. –í—ã–∑–æ–≤ bulkUpdateProducts –∏–∑ –º–æ–¥—É–ª—è bulkOperations
   * 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   * 4. –í—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   * 
   * @param {Array} products - –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   *                           –ö–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å: id, bar1, bar2, cold_room
   * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   * 
   * –§–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞:
   * {
   *   success: boolean,
   *   total: number,
   *   updated: number,
   *   failed: number,
   *   errors: Array,
   *   duration: number
   * }
   * 
   * @throws {Error} –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –µ—Å–ª–∏ failed > 0
   */
  async syncAll(products) {
    // ============================================================
    // –í–ê–õ–ò–î–ê–¶–ò–Ø
    // ============================================================
    
    if (!this.client) {
      throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
    }
    
    if (!products || products.length === 0) {
      console.log('‚ö†Ô∏è syncAll: –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏')
      return { 
        success: true, 
        total: 0, 
        updated: 0, 
        failed: 0,
        errors: [],
        duration: 0
      }
    }

    console.log(`üîÑ –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ Bulk RPC...`)
    
    // ============================================================
    // –í–´–ó–û–í BULK RPC
    // ============================================================
    
    try {
      const result = await bulkUpdateProducts(products)
      
      // ============================================================
      // –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê
      // ============================================================
      
      if (!result.success || result.failed > 0) {
        // –ï—Å—Ç—å –æ—à–∏–±–∫–∏ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        const errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å ${result.failed} –∏–∑ ${result.total} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`
        console.error('‚ùå', errorMessage)
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫:', result.errors)
        
        throw new Error(errorMessage)
      }
      
      // –£—Å–ø–µ—à–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
      console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:`)
      console.log(`   ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${result.updated}/${result.total}`)
      console.log(`   ‚Ä¢ –í—Ä–µ–º—è: ${result.duration}–º—Å`)
      
      return result
      
    } catch (error) {
      // ============================================================
      // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
      // ============================================================
      
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error)
      throw error
    }
  }

  /**
   * ============================================================
   * –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
   * ============================================================
   * 
   * @deprecated –£—Å—Ç–∞—Ä–µ–ª, —Ä–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ email –≤ AuthContext
   * –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   * 
   * @param {string} userId - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<Object>} –ó–∞–≥–ª—É—à–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
   */
  async fetchUserProfile(userId) {
    console.warn('‚ö†Ô∏è fetchUserProfile –≤—ã–∑–≤–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.')
    console.warn('   –†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ email –≤ AuthContext')
    
    return {
      id: userId,
      role: 'bar1',
      email: 'unknown@local'
    }
  }
}

/**
 * ============================================================
 * –≠–ö–°–ü–û–†–¢
 * ============================================================
 */

// –≠–∫—Å–ø–æ—Ä—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ API (Singleton pattern)
export default new SupabaseAPI()
